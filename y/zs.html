<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>充值最优方案计算器</title>
  <!-- 载入 footer 样式 -->
  <link rel="stylesheet" href="/footer.css" />
  <!-- 载入 footer 样式 -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">充值最优方案计算器</h1>
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <input id="budgetInput" type="number" value="550" class="border rounded p-2 w-32" placeholder="预算 (元)" />
      <input id="accumTargetInput" type="number" value="100000000" class="border rounded p-2 w-48" placeholder="累计目标钻石 (默认1亿)" />
      <button onclick="calculate()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">计算</button>
    </div>
    <div id="plansContainer" class="grid gap-4 mb-8"></div>
    <div id="rankingContainer" class="mt-8"></div>
  </div>

  <script>
    const rechargeOptions = [
      { cost: 10, diamonds: 2000000 },
      { cost: 20, diamonds: 4000000 },
      { cost: 30, diamonds: 6000000 },
      { cost: 50, diamonds: 10000000 },
      { cost: 100, diamonds: 30000000 },
      { cost: 200, diamonds: 60000000 },
      { cost: 300, diamonds: 90000000 },
      { cost: 500, diamonds: 200000000 },
      { cost: 1000, diamonds: 500000000 },
      { cost: 1500, diamonds: 750000000 },
      { cost: 2000, diamonds: 1200000000 },
      { cost: 3000, diamonds: 2100000000 },
    ];

    const ACCUM_REWARD = 145000000;

    function formatDiamonds(num) {
      if (num >= 100000000) {
        return (num / 100000000).toFixed(2) + " 亿";
      } else {
        return (num / 10000).toFixed(0) + " 万";
      }
    }

    function findBestAccumCombo(target){
      const n = rechargeOptions.length;
      let best = null;

      for(let i=0;i<n;i++){
        const a = rechargeOptions[i];
        check([a]);
        for(let j=i;j<n;j++){
          const b = rechargeOptions[j];
          check([a,b]);
          for(let k=j;k<n;k++){
            const c = rechargeOptions[k];
            check([a,b,c]);
          }
        }
      }

      function check(picks){
        const totalDiamonds = picks.reduce((s,p)=>s+p.diamonds,0);
        const totalCost = picks.reduce((s,p)=>s+p.cost,0);
        if(totalDiamonds < target) return;
        const over = totalDiamonds - target;
        const totalWithReward = totalDiamonds + ACCUM_REWARD;

        if(!best 
          || totalWithReward > best.totalWithReward
          || (totalWithReward === best.totalWithReward && totalCost < best.cost)
          || (totalWithReward === best.totalWithReward && totalCost === best.cost && over < best.over)
          || (totalWithReward === best.totalWithReward && totalCost === best.cost && over === best.over && picks.length < best.picks.length)){
          best = { cost: totalCost, diamonds: totalDiamonds, picks, over, totalWithReward };
        }
      }

      if(!best){
        const top = [rechargeOptions[n-1], rechargeOptions[n-1], rechargeOptions[n-1]];
        best = { cost: top[0].cost*3, diamonds: top[0].diamonds*3, picks: top, over: top[0].diamonds*3 - target, totalWithReward: top[0].diamonds*3 + ACCUM_REWARD };
      }

      const days = best.picks.map((p,idx)=>({ day: idx+1, option: p.cost, diamonds: p.diamonds }));
      return { cost: best.cost, diamonds: best.diamonds, days, totalWithReward: best.totalWithReward };
    }

    function calculatePlans(budget, accumTarget) {
      const acc = findBestAccumCombo(accumTarget);
      const accumDays = acc.days;
      const accumCost = acc.cost;

      let onlyAcc = {
        name: "只累计奖励 (前三天累计)",
        cost: accumCost,
        diamonds: acc.totalWithReward,
        efficiency: acc.totalWithReward / (accumCost * 10000),
        schedule: accumDays,
        valid: budget >= accumCost,
      };

      let onlyConsec = {
        name: "只连续奖励",
        cost: 350,
        diamonds: 140000000,
        efficiency: 140000000 / (350 * 10000),
        schedule: Array.from({ length: 7 }, (_, i) => ({ day: i+1, option: "50", diamonds: 10000000 })),
        valid: budget >= 350,
      };

      let both = (()=>{
        const extraDaysNeeded = Math.max(0, 7 - accumDays.length);
        const extraCost = extraDaysNeeded * 50;
        const extraList = Array.from({length: extraDaysNeeded}, (_,i)=>({ day: accumDays.length + (i+1), option: "50", diamonds: 10000000 }));
        const totalWithReward = acc.totalWithReward + 70000000;
        return {
          name: "累计+连续",
          cost: accumCost + extraCost,
          diamonds: totalWithReward,
          efficiency: totalWithReward / ((accumCost + extraCost) * 10000),
          schedule: [...accumDays, ...extraList],
          valid: budget >= (accumCost + extraCost),
        };
      })();

      let bestBig = rechargeOptions
        .filter(o => o.cost <= budget)
        .sort((a, b) => (b.diamonds - a.diamonds) || (a.cost - b.cost))[0];

      let bigPlan = bestBig ? {
        name: `直接买大包(${bestBig.cost}元)`,
        cost: bestBig.cost,
        diamonds: bestBig.diamonds,
        efficiency: bestBig.diamonds / (bestBig.cost * 10000),
        schedule: [ { day: 1, option: `${bestBig.cost}`, diamonds: bestBig.diamonds } ],
        valid: true,
      } : null;

      return [onlyAcc, onlyConsec, both, bigPlan].filter(Boolean);
    }

    function calculate() {
      const budget = Number(document.getElementById("budgetInput").value);
      const accumTarget = Number(document.getElementById("accumTargetInput").value) || 100000000;
      const plans = calculatePlans(budget, accumTarget);
      const container = document.getElementById("plansContainer");
      container.innerHTML = "";

      plans.forEach(plan => {
        const card = document.createElement("div");
        card.className = "border rounded-xl p-4 bg-white shadow";
        card.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">${plan.name}</h2>
          ${plan.valid ? `
            <ul class="mb-2 space-y-1">
              <li>花费：${plan.cost} 元</li>
              <li>总钻石：${formatDiamonds(plan.diamonds)}</li>
              <li>单位成本：${plan.efficiency.toFixed(5)} 元 / 万钻</li>
            </ul>
            <div>
              <p class="font-medium mb-1">逐日购买明细：</p>
              <ul class="list-disc pl-5 space-y-1 text-sm">
                ${plan.schedule.map(s => `<li>第${s.day}天：买 ${s.option} 档 → ${formatDiamonds(s.diamonds)}</li>`).join("")}
              </ul>
            </div>
          ` : `<p class='text-gray-500'>预算不足，无法执行该方案</p>`}
        `;
        container.appendChild(card);
      });

      // 排序表
      const sorted = [...plans].filter(p=>p.valid).sort((a,b)=> b.diamonds - a.diamonds);
      const rankingContainer = document.getElementById("rankingContainer");
      if(sorted.length){
        rankingContainer.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">方案钻石总量排名</h2>
          <table class="min-w-full border text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1">方案</th>
                <th class="border px-2 py-1">花费</th>
                <th class="border px-2 py-1">总钻石</th>
                <th class="border px-2 py-1">单位成本</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(p=>`
                <tr>
                  <td class="border px-2 py-1">${p.name}</td>
                  <td class="border px-2 py-1">${p.cost} 元</td>
                  <td class="border px-2 py-1">${formatDiamonds(p.diamonds)}</td>
                  <td class="border px-2 py-1">${p.efficiency.toFixed(5)} 元/万钻</td>
                </tr>`).join("")}
            </tbody>
          </table>
        `;
      } else {
        rankingContainer.innerHTML = "";
      }
    }

    window.onload = calculate;
  </script>

  <!-- Footer -->
  <div class="footer-wrapper">
    <footer id="footer-container">加载中...</footer>
  </div>
  <script src="/load-footer.js"></script>
  <!-- footer -->
</body>
</html>
