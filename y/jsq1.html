<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="footer.css" />
  <title>é’»çŸ³è®¡ç®—å™¨v.3.0</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 20px;
      gap: 20px;
      background: #f9f9f9;
      color: #333;
    }
    main {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    #exchangeSummary {
      width: 360px;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      background: #fff;
      height: fit-content;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
      overflow-y: auto;
      font-size: 14px;
    }
    h1, h2 {
      margin-top: 0;
      color: #2c3e50;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    #total, #draw {
      margin-top: 15px;
      font-weight: 600;
      font-size: 16px;
      color: #34495e;
    }
    ul {
      padding-left: 20px;
      margin: 0;
    }
    li {
      margin-bottom: 14px;
      line-height: 1.4;
    }
    .success {
      color: #27ae60;
      font-weight: 600;
    }
    .fail {
      color: #c0392b;
      font-weight: 600;
    }
    input[type="text"] {
      width: 90px;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: right;
    }
    input[type="text"]:focus {
      border-color: #2980b9;
      box-shadow: 0 0 5px #2980b9;
    }
    button {
      margin-top: 12px;
      padding: 8px 15px;
      font-size: 14px;
      background-color: #2980b9;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #1c5980;
    }
    .copy-btn {
      margin-top: 6px;
      font-size: 12px;
      background-color: #2ecc71;
    }
    .copy-btn:hover {
      background-color: #239b56;
    }
  </style>
</head>
<body>
<main>
  <h1>é’»çŸ³è®¡ç®—å™¨v.1.5.5</h1>

  <div style="margin-bottom: 10px;">
    <button id="clearBtn">æ¸…ç©ºæ•°é‡</button>
  </div>

  <table>
    <thead>
      <tr><th>é“å…·</th><th>å•ä»·ï¼ˆé’»çŸ³ï¼‰</th><th>æ•°é‡</th><th>å°è®¡</th></tr>
    </thead>
    <tbody id="itemTable"></tbody>
  </table>

  <div id="total">æ€»é’»çŸ³ï¼š0ï¼ˆé›¶ï¼‰</div>
  <div id="draw">å¯æŠ½å¥–æ¬¡æ•°ï¼š0 æ¬¡ï¼ˆ50 æ¬¡æŠ½å¥–éœ€ 500000 é’»çŸ³ï¼‰</div>

  <footer id="footer-container">åŠ è½½ä¸­...</footer>
</main>

<aside id="exchangeSummary">
  <h2>ğŸ’ å›ºå®šé’»çŸ³ç›®æ ‡å…‘æ¢æ–¹æ¡ˆ</h2>
  <button id="calcExchangeBtn">è®¡ç®—å…‘æ¢æ–¹æ¡ˆ</button>
  <ul id="exchangeList">
    <li>è¯·å…ˆè¾“å…¥é“å…·æ•°é‡ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è®¡ç®—å…‘æ¢æ–¹æ¡ˆã€‚</li>
  </ul>
</aside>

<script>
const items = [
  { name: "å¯ä¹", price: 10 },
  { name: "æ©™æ±", price: 20 },
  { name: "æ‰“ç«æœº", price: 50 },
  { name: "å°éŸ³å“", price: 100 },
  { name: "é¼ æ ‡", price: 200 },
  { name: "è€³æœº", price: 500 },
  { name: "æ‰‹è¡¨", price: 1000 },
  { name: "æ‰‹æœº", price: 2000 },
  { name: "æ‘©æ‰˜è½¦", price: 5000 },
  { name: "æ³•æ‹‰åˆ©", price: 10000 }
];

const exchangeTargets = [100000, 500000, 1000000, 4000000, 10000000, 20000000];

function numberToChinese(num) {
  if(num === 0) return "é›¶";
  const digitToCN = ["é›¶","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];
  const unit = ["","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡","åƒä¸‡","äº¿"];
  let str = num.toString();
  let res = "";
  let zeroFlag = false;
  for(let i=0; i<str.length; i++){
    let n = +str[i];
    let pos = str.length - i -1;
    if(n === 0){
      zeroFlag = true;
    } else {
      if(zeroFlag) { res += "é›¶"; zeroFlag=false; }
      res += digitToCN[n] + unit[pos];
    }
  }
  return res.replace(/é›¶+$/,"");
}

function createTable(){
  const tbody = document.getElementById("itemTable");
  items.forEach((item, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.price}</td>
      <td><input type="text" id="qty-${idx}" value="0" inputmode="numeric" pattern="[0-9]*" /></td>
      <td id="subtotal-${idx}">0</td>
    `;
    tbody.appendChild(tr);
  });
  const inputs = document.querySelectorAll("input[type='text']");
  let debounceTimer;
  inputs.forEach(input => {
    input.addEventListener("input", () => {
      input.value = input.value.replace(/[^\d]/g, "");
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        calculateTotal();
      }, 300);
    });
  });
}

function calculateTotal(){
  let total = 0;
  items.forEach((item, idx) => {
    let qty = parseInt(document.getElementById(`qty-${idx}`).value) || 0;
    const subtotal = qty * item.price;
    document.getElementById(`subtotal-${idx}`).textContent = subtotal;
    total += subtotal;
  });
  document.getElementById("total").textContent = `æ€»é’»çŸ³ï¼š${total}ï¼ˆ${numberToChinese(total)}ï¼‰`;
  const draws = Math.floor(total / 500000);
  document.getElementById("draw").textContent = `å¯æŠ½å¥–æ¬¡æ•°ï¼š${draws} æ¬¡ï¼ˆ50 æ¬¡æŠ½å¥–éœ€ 500000 é’»çŸ³ï¼‰`;
}

function calcBestExchange(target, itemsAvailable) {
  const sorted = itemsAvailable.slice().sort((a,b)=>b.price - a.price);
  let remain = target;
  const countMap = {};
  for(let i=0; i<sorted.length; i++){
    let maxUse = Math.min(sorted[i].qty, Math.floor(remain / sorted[i].price));
    if(maxUse > 0){
      countMap[sorted[i].name] = maxUse;
      remain -= maxUse * sorted[i].price;
    }
  }
  if(remain > 0){
    let minItem = itemsAvailable.reduce((min, cur) => cur.price < min.price ? cur : min, itemsAvailable[0]);
    if(minItem.qty > (countMap[minItem.name]||0)){
      countMap[minItem.name] = (countMap[minItem.name]||0) + 1;
      remain -= minItem.price;
    }
  }
  let sum = 0;
  for(let name in countMap){
    const item = items.find(i => i.name === name);
    sum += item.price * countMap[name];
  }
  if(sum < target) return null;
  return { sum, countMap, exceed: sum - target };
}

function calculateAllExchanges(){
  const available = [];
  items.forEach((item, idx) => {
    let qtyInput = document.getElementById(`qty-${idx}`);
    let qty = parseInt(qtyInput.value);
    if(isNaN(qty) || qty < 0) qty = 0;
    if(qty > 0){
      available.push({
        name: item.name,
        price: item.price,
        qty: qty
      });
    }
  });

  const ul = document.getElementById("exchangeList");
  ul.innerHTML = "";

  if(available.length === 0){
    ul.innerHTML = "<li>è¯·å…ˆè¾“å…¥é“å…·æ•°é‡ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è®¡ç®—å…‘æ¢æ–¹æ¡ˆã€‚</li>";
    return;
  }

  exchangeTargets.forEach(target => {
    const res = calcBestExchange(target, available);
    const li = document.createElement("li");
    if(res === null){
      li.innerHTML = `ğŸ’ <strong>${target.toLocaleString()}</strong> é’»çŸ³å…‘æ¢ï¼š<span class="fail">æ— æ³•å…‘æ¢ï¼Œç°æœ‰é“å…·é’»çŸ³æ€»é¢ä¸è¶³ã€‚</span>`;
    } else {
      const useStrArr = [];
      items.forEach(i => {
        if(res.countMap[i.name]){
          useStrArr.push(`${i.name} Ã— ${res.countMap[i.name]}`);
        }
      });
      const itemsStr = useStrArr.join("ï¼Œ");
      const resultText = `ğŸ’ ${target.toLocaleString()} é’»çŸ³å…‘æ¢ï¼šå¯å…‘æ¢ï¼ˆæ€»è®¡ ${res.sum.toLocaleString()} é’»çŸ³ï¼Œè¶…å‡º ${res.exceed.toLocaleString()}ï¼‰\nä½¿ç”¨ï¼š${itemsStr}`;
      li.innerHTML = `ğŸ’ <strong>${target.toLocaleString()}</strong> é’»çŸ³å…‘æ¢ï¼š<span class="success">å¯å…‘æ¢ï¼ˆæ€»è®¡ ${res.sum.toLocaleString()} é’»çŸ³ï¼Œè¶…å‡º ${res.exceed.toLocaleString()}ï¼‰</span><br>ä½¿ç”¨ï¼š${itemsStr}`;
      if(target === 1000000){
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "å¤åˆ¶";
        copyBtn.className = "copy-btn";
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(resultText).then(() => {
            copyBtn.textContent = "å·²å¤åˆ¶!";
            setTimeout(() => copyBtn.textContent = "å¤åˆ¶", 1500);
          });
        });
        li.appendChild(copyBtn);
      }
    }
    ul.appendChild(li);
  });
}

document.getElementById("calcExchangeBtn").addEventListener("click", calculateAllExchanges);

document.getElementById("clearBtn").addEventListener("click", () => {
  const inputs = document.querySelectorAll("input[type='text']");
  inputs.forEach(input => input.value = "0");
  calculateTotal();
});

createTable();
calculateTotal();

// Footer åŠ è½½
function hideCurrentPageLink() {
  const currentPath = window.location.pathname.replace(/\/+$/, '');
  const links = document.querySelectorAll('.footer-content a');
  links.forEach(link => {
    const href = link.getAttribute('href');
    if (!href) return;
    const linkPath = new URL(href, window.location.origin).pathname.replace(/\/+$/, '');
    if (linkPath === currentPath) {
      link.style.display = 'none';
    }
  });
}
fetch('footer.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('footer-container').innerHTML = html;
    hideCurrentPageLink();
  })
  .catch(() => {
    document.getElementById('footer-container').textContent = 'åŠ è½½ footer å¤±è´¥';
  });
</script>
</body>
</html>
