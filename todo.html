<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>✓</title>
  <link rel="stylesheet" href="/footer.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    .main-container {
      display: flex;
      flex-direction: row;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      gap: 20px;
    }
    .left-panel, .right-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .left-panel {
      flex: 1;
      min-width: 300px;
    }
    .right-panel {
      flex: 1;
      min-width: 300px;
    }
    h2 { margin-top: 0; text-align: center; }
    h3 { margin: 16px 0 10px; color: #333; font-size: 18px; }

    input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    .task {
      margin-bottom: 8px;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .buttons button {
      flex: 1 1 45%;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }
    .submit-btn { background-color: #0078d7; }
    .export-btn { background-color: #6c757d; }
    .import-btn { background-color: #17a2b8; }
    .clear-btn { background-color: #dc3545; }

    .status-summary {
      font-size: 16px;
      line-height: 1.8;
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      .buttons button {
        flex: 1 1 100%;
      }
      input[type="number"], .task label {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- 左栏 -->
    <div class="left-panel">
      <h2>任务填写</h2>
      <input type="number" id="server" placeholder="请输入区服数字，例如123" />

      <div style="margin: 10px 0;">
        <button onclick="checkAllTasks()">✅ 全部勾选</button>
        <button onclick="uncheckAllTasks()">❌ 全部取消</button>
      </div>

      <div id="task-list"></div>

      <div class="buttons">
        <button class="submit-btn" onclick="submitTasks()">提交</button>
        <button class="export-btn" onclick="exportToText('txt')">导出TXT</button>
        <button class="export-btn" onclick="exportToText('md')">复制Markdown</button>
        <button class="export-btn" onclick="exportJSON()">导出JSON</button>
        <button class="import-btn" onclick="document.getElementById('fileInput').click()">导入JSON</button>
        <button class="clear-btn" onclick="confirmClear()">清除所有</button>
      </div>
      <input type="file" id="fileInput" style="display:none" onchange="importJSON(event)" accept=".json" />
    </div>

    <!-- 右栏 -->
    <div class="right-panel">
      <h2>今日状态汇总</h2>
      <div class="status-summary" id="status-summary">
        <p>请勾选任务以查看完成情况。</p>
      </div>
    </div>
  </div>

  <script>
    const DAILY_TASKS = [
      '赏金猎人', '降魔道人', '试炼道人', '回收金不换',
      '封神法器1/4', '封神法器2/4', '封神法器3/4', '封神法器4/4',
      '每日充值50万钻石', '每日充值100万钻石',
      '神秘商人5/5'
    ];

    const DUNGEON_TASKS = [
      '魔宫试炼1/3', '魔宫试炼2/3', '魔宫试炼3/3',
      '异界时空5/15', '异界时空10/15', '异界时空15/15',
      '魔灵幻狱/沙海魔楼1/4', '魔灵幻狱/沙海魔楼2/4',
      '魔灵幻狱/沙海魔楼3/4', '魔灵幻狱/沙海魔楼4/4'
    ];

    const TASKS = [...DAILY_TASKS, ...DUNGEON_TASKS];

    function createTaskGroup(title, tasks, startIndex) {
      const wrapper = document.createElement('div');
      const heading = document.createElement('h3');
      heading.textContent = title;
      wrapper.appendChild(heading);

      tasks.forEach((task, i) => {
        const idx = startIndex + i;
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `<label><input type="checkbox" id="task-${idx}" onchange="updateStatus()"> ${task}</label>`;
        wrapper.appendChild(div);
      });

      return wrapper;
    }

    function createTaskList() {
      const container = document.getElementById('task-list');
      container.innerHTML = '';
      const dailyGroup = createTaskGroup("🟢 日常项目", DAILY_TASKS, 0);
      const dungeonGroup = createTaskGroup("🔵 副本项目", DUNGEON_TASKS, DAILY_TASKS.length);
      container.appendChild(dailyGroup);
      container.appendChild(dungeonGroup);
    }

    function getCheckedTasks() {
      const checked = [];
      TASKS.forEach((task, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb && cb.checked) checked.push(task);
      });
      return checked;
    }

    function updateStatus() {
      const summary = document.getElementById('status-summary');
      const date = new Date().toISOString().split('T')[0];
      const records = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      const today = records.filter(r => r.date === date);
      if (today.length === 0) {
        summary.innerHTML = `<p>暂无今日记录</p>`;
        return;
      }

      const zoneMap = {};
      today.forEach(r => {
        if (!zoneMap[r.server]) zoneMap[r.server] = new Set();
        r.tasks.forEach(task => zoneMap[r.server].add(task));
      });

      let html = '';
      for (const zone in zoneMap) {
        const done = Array.from(zoneMap[zone]);
        const doneCount = done.length;
        const percent = Math.round((doneCount / TASKS.length) * 100);
        const barColor = percent === 100 ? '#28a745' : '#dc3545';

        html += `
          <div style="margin-bottom: 16px;">
            <strong>${zone}区</strong> - ${doneCount} / ${TASKS.length} 项完成
            <div style="background:#eee;border-radius:6px;overflow:hidden;height:16px;margin-top:6px;">
              <div style="width:${percent}%;background:${barColor};height:100%;transition:width 0.3s;"></div>
            </div>
          </div>
        `;
      }

      summary.innerHTML = html;
    }

    function submitTasks() {
      const server = document.getElementById("server").value.trim();
      if (!server) return showMessage("请填写区服数字！", "error");

      const completed = getCheckedTasks();
      if (!completed.length) return showMessage("请至少选择一个任务", "error");

      const now = new Date();
      const record = {
        server,
        tasks: completed,
        time: now.toLocaleString(),
        date: now.toISOString().split('T')[0]
      };
      const all = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      all.unshift(record);
      localStorage.setItem("taskRecords", JSON.stringify(all));
      showMessage("记录已提交");
      updateStatus();
    }

    function showMessage(text, type = "ok") {
      const msg = document.createElement("div");
      msg.textContent = text;
      msg.style.position = "fixed";
      msg.style.top = "20px";
      msg.style.left = "50%";
      msg.style.transform = "translateX(-50%)";
      msg.style.backgroundColor = type === "ok" ? "#28a745" : "#dc3545";
      msg.style.color = "white";
      msg.style.padding = "10px 20px";
      msg.style.borderRadius = "6px";
      msg.style.zIndex = 9999;
      document.body.appendChild(msg);
      setTimeout(() => document.body.removeChild(msg), 3000);
    }

    function exportToText(type) {
      const date = new Date().toISOString().split('T')[0];
      const records = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      const today = records.filter(r => r.date === date);
      const byZone = {};
      today.forEach(r => {
        if (!byZone[r.server]) byZone[r.server] = new Set();
        r.tasks.forEach(task => byZone[r.server].add(task));
      });

      let content = type === 'md' ? `# ${date} 未完成任务统计\n\n` : `${date} 未完成任务统计\n\n`;
      for (const zone in byZone) {
        const done = Array.from(byZone[zone]);
        const undone = TASKS.filter(t => !done.includes(t));
        content += `- ${zone}区：${undone.length ? `❌ 未完成：${undone.join("，")}` : '✅ 所有任务完成'}\n`;
      }

      if (type === 'md') {
        navigator.clipboard.writeText(content).then(() => {
          showMessage("Markdown内容已复制到剪贴板");
        }).catch(() => {
          showMessage("复制失败", "error");
        });
      } else {
        const blob = new Blob([content], { type: "text/plain" });
        const link = document.createElement("a");
        link.download = `未完成统计_${date}.${type}`;
        link.href = URL.createObjectURL(blob);
        link.click();
      }
    }

    function exportJSON() {
      const data = localStorage.getItem("taskRecords") || "[]";
      const blob = new Blob([data], { type: "application/json" });
      const link = document.createElement("a");
      link.download = `任务记录_${Date.now()}.json`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) throw new Error("格式错误");
          localStorage.setItem("taskRecords", JSON.stringify(data));
          showMessage("导入成功");
          updateStatus();
        } catch {
          showMessage("导入失败", "error");
        }
      };
      reader.readAsText(file);
    }

    function confirmClear() {
      if (confirm("确定清除所有任务记录？")) {
        localStorage.removeItem("taskRecords");
        showMessage("已清除所有记录");
        updateStatus();
      }
    }

    function checkAllTasks() {
      TASKS.forEach((_, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb) cb.checked = true;
      });
      updateStatus();
    }

    function uncheckAllTasks() {
      TASKS.forEach((_, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb) cb.checked = false;
      });
      updateStatus();
    }

    // 初始化
    createTaskList();
    updateStatus();
  </script>

  <div class="footer-wrapper">
    <footer id="footer-container">加载中...</footer>
  </div>
  <script src="/load-footer.js"></script>
</body>
</html>
