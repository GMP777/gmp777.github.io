<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>âœ“</title>
  <link rel="stylesheet" href="/footer.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    .main-container {
      display: flex;
      flex-direction: row;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      gap: 20px;
    }
    .left-panel, .right-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .left-panel {
      flex: 1;
      min-width: 300px;
    }
    .right-panel {
      flex: 1;
      min-width: 300px;
    }
    h2 { margin-top: 0; text-align: center; }
    h3 { margin: 16px 0 10px; color: #333; font-size: 18px; }

    input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    .task {
      margin-bottom: 8px;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .buttons button {
      flex: 1 1 45%;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }
    .submit-btn { background-color: #0078d7; }
    .export-btn { background-color: #6c757d; }
    .import-btn { background-color: #17a2b8; }
    .clear-btn { background-color: #dc3545; }

    .status-summary {
      font-size: 16px;
      line-height: 1.8;
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      .buttons button {
        flex: 1 1 100%;
      }
      input[type="number"], .task label {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- å·¦æ  -->
    <div class="left-panel">
      <h2>ä»»åŠ¡å¡«å†™</h2>
      <input type="number" id="server" placeholder="è¯·è¾“å…¥åŒºæœæ•°å­—ï¼Œä¾‹å¦‚123" />

      <div style="margin: 10px 0;">
        <button onclick="checkAllTasks()">âœ… å…¨éƒ¨å‹¾é€‰</button>
        <button onclick="uncheckAllTasks()">âŒ å…¨éƒ¨å–æ¶ˆ</button>
      </div>

      <div id="task-list"></div>

      <div class="buttons">
        <button class="submit-btn" onclick="submitTasks()">æäº¤</button>
        <button class="export-btn" onclick="exportToText('txt')">å¯¼å‡ºTXT</button>
        <button class="export-btn" onclick="exportToText('md')">å¤åˆ¶Markdown</button>
        <button class="export-btn" onclick="exportJSON()">å¯¼å‡ºJSON</button>
        <button class="import-btn" onclick="document.getElementById('fileInput').click()">å¯¼å…¥JSON</button>
        <button class="clear-btn" onclick="confirmClear()">æ¸…é™¤æ‰€æœ‰</button>
      </div>
      <input type="file" id="fileInput" style="display:none" onchange="importJSON(event)" accept=".json" />
    </div>

    <!-- å³æ  -->
    <div class="right-panel">
      <h2>ä»Šæ—¥çŠ¶æ€æ±‡æ€»</h2>
      <div class="status-summary" id="status-summary">
        <p>è¯·å‹¾é€‰ä»»åŠ¡ä»¥æŸ¥çœ‹å®Œæˆæƒ…å†µã€‚</p>
      </div>
    </div>
  </div>

  <script>
    const DAILY_TASKS = [
      'èµé‡‘çŒäºº', 'é™é­”é“äºº', 'è¯•ç‚¼é“äºº', 'å›æ”¶é‡‘ä¸æ¢',
      'å°ç¥æ³•å™¨1/4', 'å°ç¥æ³•å™¨2/4', 'å°ç¥æ³•å™¨3/4', 'å°ç¥æ³•å™¨4/4',
      'æ¯æ—¥å……å€¼50ä¸‡é’»çŸ³', 'æ¯æ—¥å……å€¼100ä¸‡é’»çŸ³',
      'ç¥ç§˜å•†äºº5/5'
    ];

    const DUNGEON_TASKS = [
      'é­”å®«è¯•ç‚¼1/3', 'é­”å®«è¯•ç‚¼2/3', 'é­”å®«è¯•ç‚¼3/3',
      'å¼‚ç•Œæ—¶ç©º5/15', 'å¼‚ç•Œæ—¶ç©º10/15', 'å¼‚ç•Œæ—¶ç©º15/15',
      'é­”çµå¹»ç‹±/æ²™æµ·é­”æ¥¼1/4', 'é­”çµå¹»ç‹±/æ²™æµ·é­”æ¥¼2/4',
      'é­”çµå¹»ç‹±/æ²™æµ·é­”æ¥¼3/4', 'é­”çµå¹»ç‹±/æ²™æµ·é­”æ¥¼4/4'
    ];

    const TASKS = [...DAILY_TASKS, ...DUNGEON_TASKS];

    function createTaskGroup(title, tasks, startIndex) {
      const wrapper = document.createElement('div');
      const heading = document.createElement('h3');
      heading.textContent = title;
      wrapper.appendChild(heading);

      tasks.forEach((task, i) => {
        const idx = startIndex + i;
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `<label><input type="checkbox" id="task-${idx}" onchange="updateStatus()"> ${task}</label>`;
        wrapper.appendChild(div);
      });

      return wrapper;
    }

    function createTaskList() {
      const container = document.getElementById('task-list');
      container.innerHTML = '';
      const dailyGroup = createTaskGroup("ğŸŸ¢ æ—¥å¸¸é¡¹ç›®", DAILY_TASKS, 0);
      const dungeonGroup = createTaskGroup("ğŸ”µ å‰¯æœ¬é¡¹ç›®", DUNGEON_TASKS, DAILY_TASKS.length);
      container.appendChild(dailyGroup);
      container.appendChild(dungeonGroup);
    }

    function getCheckedTasks() {
      const checked = [];
      TASKS.forEach((task, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb && cb.checked) checked.push(task);
      });
      return checked;
    }

    function updateStatus() {
      const summary = document.getElementById('status-summary');
      const date = new Date().toISOString().split('T')[0];
      const records = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      const today = records.filter(r => r.date === date);
      if (today.length === 0) {
        summary.innerHTML = `<p>æš‚æ— ä»Šæ—¥è®°å½•</p>`;
        return;
      }

      const zoneMap = {};
      today.forEach(r => {
        if (!zoneMap[r.server]) zoneMap[r.server] = new Set();
        r.tasks.forEach(task => zoneMap[r.server].add(task));
      });

      let html = '';
      for (const zone in zoneMap) {
        const done = Array.from(zoneMap[zone]);
        const doneCount = done.length;
        const percent = Math.round((doneCount / TASKS.length) * 100);
        const barColor = percent === 100 ? '#28a745' : '#dc3545';

        html += `
          <div style="margin-bottom: 16px;">
            <strong>${zone}åŒº</strong> - ${doneCount} / ${TASKS.length} é¡¹å®Œæˆ
            <div style="background:#eee;border-radius:6px;overflow:hidden;height:16px;margin-top:6px;">
              <div style="width:${percent}%;background:${barColor};height:100%;transition:width 0.3s;"></div>
            </div>
          </div>
        `;
      }

      summary.innerHTML = html;
    }

    function submitTasks() {
      const server = document.getElementById("server").value.trim();
      if (!server) return showMessage("è¯·å¡«å†™åŒºæœæ•°å­—ï¼", "error");

      const completed = getCheckedTasks();
      if (!completed.length) return showMessage("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä»»åŠ¡", "error");

      const now = new Date();
      const record = {
        server,
        tasks: completed,
        time: now.toLocaleString(),
        date: now.toISOString().split('T')[0]
      };
      const all = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      all.unshift(record);
      localStorage.setItem("taskRecords", JSON.stringify(all));
      showMessage("è®°å½•å·²æäº¤");
      updateStatus();
    }

    function showMessage(text, type = "ok") {
      const msg = document.createElement("div");
      msg.textContent = text;
      msg.style.position = "fixed";
      msg.style.top = "20px";
      msg.style.left = "50%";
      msg.style.transform = "translateX(-50%)";
      msg.style.backgroundColor = type === "ok" ? "#28a745" : "#dc3545";
      msg.style.color = "white";
      msg.style.padding = "10px 20px";
      msg.style.borderRadius = "6px";
      msg.style.zIndex = 9999;
      document.body.appendChild(msg);
      setTimeout(() => document.body.removeChild(msg), 3000);
    }

    function exportToText(type) {
      const date = new Date().toISOString().split('T')[0];
      const records = JSON.parse(localStorage.getItem("taskRecords") || "[]");
      const today = records.filter(r => r.date === date);
      const byZone = {};
      today.forEach(r => {
        if (!byZone[r.server]) byZone[r.server] = new Set();
        r.tasks.forEach(task => byZone[r.server].add(task));
      });

      let content = type === 'md' ? `# ${date} æœªå®Œæˆä»»åŠ¡ç»Ÿè®¡\n\n` : `${date} æœªå®Œæˆä»»åŠ¡ç»Ÿè®¡\n\n`;
      for (const zone in byZone) {
        const done = Array.from(byZone[zone]);
        const undone = TASKS.filter(t => !done.includes(t));
        content += `- ${zone}åŒºï¼š${undone.length ? `âŒ æœªå®Œæˆï¼š${undone.join("ï¼Œ")}` : 'âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ'}\n`;
      }

      if (type === 'md') {
        navigator.clipboard.writeText(content).then(() => {
          showMessage("Markdownå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }).catch(() => {
          showMessage("å¤åˆ¶å¤±è´¥", "error");
        });
      } else {
        const blob = new Blob([content], { type: "text/plain" });
        const link = document.createElement("a");
        link.download = `æœªå®Œæˆç»Ÿè®¡_${date}.${type}`;
        link.href = URL.createObjectURL(blob);
        link.click();
      }
    }

    function exportJSON() {
      const data = localStorage.getItem("taskRecords") || "[]";
      const blob = new Blob([data], { type: "application/json" });
      const link = document.createElement("a");
      link.download = `ä»»åŠ¡è®°å½•_${Date.now()}.json`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) throw new Error("æ ¼å¼é”™è¯¯");
          localStorage.setItem("taskRecords", JSON.stringify(data));
          showMessage("å¯¼å…¥æˆåŠŸ");
          updateStatus();
        } catch {
          showMessage("å¯¼å…¥å¤±è´¥", "error");
        }
      };
      reader.readAsText(file);
    }

    function confirmClear() {
      if (confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰ä»»åŠ¡è®°å½•ï¼Ÿ")) {
        localStorage.removeItem("taskRecords");
        showMessage("å·²æ¸…é™¤æ‰€æœ‰è®°å½•");
        updateStatus();
      }
    }

    function checkAllTasks() {
      TASKS.forEach((_, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb) cb.checked = true;
      });
      updateStatus();
    }

    function uncheckAllTasks() {
      TASKS.forEach((_, idx) => {
        const cb = document.getElementById(`task-${idx}`);
        if (cb) cb.checked = false;
      });
      updateStatus();
    }

    // åˆå§‹åŒ–
    createTaskList();
    updateStatus();
  </script>

  <div class="footer-wrapper">
    <footer id="footer-container">åŠ è½½ä¸­...</footer>
  </div>
  <script src="/load-footer.js"></script>
</body>
</html>
